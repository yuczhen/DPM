# 特徵工程分析報告

**專案**: DPM 信用違約預測模型
**日期**: 2025-10-09
**狀態**: 待確認 (尚未執行模型訓練)

---

## 一、資料清洗結果

### 1.1 資料基本資訊
- **總筆數**: 13,271 筆
- **總欄位數**: 37 個 (無刪除任何欄位)
- **處理後檔案**: `source/DPM_data_cleaned_processed.xlsx`

### 1.2 缺失值處理策略

| 欄位類型 | 處理方式 | 筆數 | 說明 |
|---------|---------|------|------|
| **逾期相關欄位** (8個) | 填補 0 | 546 | 無逾期記錄視為 0 次逾期 |
| **月薪** | 填補中位數 | 4 | 中位數 = 4.0 萬 |
| **年資** | 填補中位數 | 2 | 中位數 = 3.0 年 |
| **已繳期數** | 填補 0 | 546 | 無記錄視為尚未開始繳款 |
| **主要經營業務** | 填補 "other" | 92 | 未知業務類別 |
| **教育程度** | 填補眾數 | 5 | 眾數 = "專科/大學" |
| **居住狀況** | 填補眾數 | 4 | 眾數 = "租賃" |
| **婚姻狀況** | 填補眾數 | 2 | 眾數 = "已婚" |

### 1.3 月薪範圍值處理

已修正的範圍值 (取中位數):
```
Serial 107176: "4.4-4.8"   → 4.60 萬
Serial 123602: "10-15"     → 12.5 萬
Serial 129207: "3.5-4"     → 3.75 萬
Serial 152300: "3.4-3.5"   → 3.45 萬
Serial 154264: "3.0."      → 3.0 萬
Serial 161033: "3.7-4.2"   → 3.95 萬
```

### 1.4 剩餘缺失值

| 欄位 | 缺失數 | 缺失率 | 處理建議 |
|------|-------|--------|---------|
| funding date | 867 | 6.53% | **保留** - 非建模特徵,僅為參考資訊 |
| loan term | 1 | 0.01% | 可填補眾數或中位數 |
| job tenure | 1 | 0.01% | 可填補中位數 3.0 |
| paid installments | 1 | 0.01% | 可填補 0 |

---

## 二、違約定義 (M1+ 規則)

### 2.1 分類邏輯

```python
def classify_default(overdue_status):
    """
    M1+ 定義: 逾期 >= 30 天視為違約

    正常 (0): Current, M0 
    違約 (1): M1, M2, M3, M4, M5, M6, ...
    """
    status_str = str(overdue_status).strip()

    if status_str in ['Current', 'M0']:
        return 0  # 正常
    else:
        if status_str.startswith('M'):
            m_number = int(status_str[1:])
            return 1 if m_number >= 2 else 0
        return 0
```

### 2.2 預期樣本分佈 (待執行確認)

根據 overdue status 欄位進行分類,預計違約率約在 10-20% 之間 (信用貸款產業平均值)。

---

## 三、特徵工程設計

### 3.1 徵審關注點

根據信用審核實務,特徵設計聚焦於:

1. **還款能力** (財務能力)
   - 借款人是否有能力償還?
   - 工作穩定性、收入水平

2. **聯絡穩定性** (找得到人)
   - 能否聯繫到借款人?
   - 地址一致性、居住穩定性

3. **信用行為** (逾期記錄)
   - 過往還款紀律如何?
   - 是否曾逾期?

### 3.2 新增衍生特徵 (共 6 個)

#### **財務能力指標 (2個)**

| 特徵名稱 | 計算公式 | 說明 | 數值範圍 |
|---------|---------|------|---------|
| `payment_progress_ratio` | `已繳期數 / 貸款總期數` | 還款進度比率,越高代表已完成較多還款 | 0.0 ~ 1.0 |
| `job_stable` | `1 if 年資 >= 1 else 0` | 工作是否穩定 (年資滿1年) | 0 or 1 |

**計算範例**:
```python
# 範例 1: 已繳 12 期 / 總共 36 期 = 0.33
payment_progress_ratio = 12 / 36 = 0.33

# 範例 2: 年資 2.5 年 → job_stable = 1
job_stable = 1 if 2.5 >= 1 else 0  # → 1
```

#### **聯絡穩定性指標 (2個)**

| 特徵名稱 | 計算公式 | 說明 | 數值範圍 |
|---------|---------|------|---------|
| `address_match` | `1 if 戶籍郵遞區號 == 居住郵遞區號 else 0` | 戶籍與居住地是否一致,一致代表較穩定 | 0 or 1 |
| `residence_stable` | `1 if 居住狀況 in ['自有','配偶名下','親友名下'] else 0` | 居住穩定性,自有房產優於租賃 | 0 or 1 |

**計算範例**:
```python
# 範例 1: 戶籍 100 台北市, 居住 100 台北市 → address_match = 1
address_match = 1 if '100' == '100' else 0  # → 1

# 範例 2: 居住狀況 = "自有" → residence_stable = 1
residence_stable = 1 if '自有' in ['自有','配偶名下','親友名下'] else 0  # → 1
```

#### **逾期行為指標 (2個)**

| 特徵名稱 | 計算公式 | 說明 | 數值範圍 |
|---------|---------|------|---------|
| `total_overdue_count` | `逾期_月前 + 逾期_上半月 + 逾期_下半月` | 總逾期次數 (前期累計) | 0, 1, 2, ... |
| `has_overdue` | `1 if total_overdue_count > 0 else 0` | 是否曾有逾期記錄 | 0 or 1 |

**計算範例**:
```python
# 範例: 月前逾期 2 次, 上半月 1 次, 下半月 0 次
total_overdue_count = 2 + 1 + 0 = 3
has_overdue = 1 if 3 > 0 else 0  # → 1
```

---

## 四、建模特徵清單

### 4.1 分類特徵 (5個) - 使用 WoE 編碼

| 欄位名稱 | 中文說明 | 唯一值數 | 優先級 | 說明 |
|---------|---------|---------|--------|------|
| `post code of residential address` | 居住地郵遞區號 | ~358 | **高** | 聯絡穩定性關鍵指標 |
| `main business` | 主要經營業務 | ~27 | **高** | 工作穩定性關鍵指標 |
| `residence status` | 居住狀況 | 6 | 中 | 財務穩定性參考 |
| `education` | 教育程度 | 10 | 低 | 非徵審重點 |
| `product` | 產品別 | 6 | 中 | 產品風險差異 |

**為何使用 WoE 編碼?**

1. **處理高基數特徵**: 郵遞區號有 358 種,直接 One-Hot 會產生 358 個欄位,WoE 只需 1 個欄位
2. **保留違約率資訊**: WoE 值反映該類別的違約傾向
3. **單調性**: WoE 與違約率呈單調關係,適合邏輯迴歸等線性模型

**WoE 計算公式**:
```
WoE = ln(Good% / Bad%)

其中:
  Good% = 該類別中正常客戶數 / 全體正常客戶數
  Bad%  = 該類別中違約客戶數 / 全體違約客戶數
```

**IV 值 (Information Value) - 特徵重要性指標**:
```
IV = Σ (Good% - Bad%) × WoE

判斷標準:
  IV > 0.3   → 強預測力
  IV > 0.1   → 中等預測力
  IV > 0.02  → 弱預測力
  IV < 0.02  → 無預測力
```

### 4.2 數值特徵 (10個)

| 欄位名稱 | 中文說明 | 特徵類型 | 優先級 |
|---------|---------|---------|--------|
| **財務能力指標** | | | |
| `month salary` | 月薪 (萬) | 原始特徵 | 高 |
| `job tenure` | 年資 (年) | 原始特徵 | 高 |
| `payment_progress_ratio` | 還款進度比率 | **衍生特徵** | 高 |
| `job_stable` | 工作穩定性 | **衍生特徵** | 中 |
| **聯絡穩定性指標** | | | |
| `address_match` | 地址一致性 | **衍生特徵** | 高 |
| `residence_stable` | 居住穩定性 | **衍生特徵** | 中 |
| **逾期行為指標** | | | |
| `total_overdue_count` | 總逾期次數 | **衍生特徵** | 高 |
| `has_overdue` | 是否有逾期 | **衍生特徵** | 高 |
| **原始特徵** | | | |
| `loan term` | 貸款總期數 | 原始特徵 | 中 |
| `paid installments` | 已繳期數 | 原始特徵 | 中 |

**最終建模特徵總數**: 15 個
- 5 個 WoE 編碼後的分類特徵
- 10 個數值特徵

---

## 五、負債比 (Debt-to-Income Ratio) 分析

### 5.1 是否可計算?

**結論: 無法計算**

**原因**:
- 缺少 **貸款金額** (loan amount)
- 缺少 **每月應繳金額** (monthly payment)

**現有資料**:
- ✓ 月薪 (month salary)
- ✓ 貸款總期數 (loan term)
- ✓ 已繳期數 (paid installments)
- ✗ 貸款金額
- ✗ 每月應繳金額

### 5.2 替代方案

使用 `payment_progress_ratio` 作為還款能力的代理指標:
```python
payment_progress_ratio = 已繳期數 / 貸款總期數
```

**意義**:
- 比率越高 → 已完成較多還款 → 還款能力/意願較佳
- 比率接近 1 → 接近還清 → 違約風險較低

---

## 六、模型超參數設定 (Wandb Sweep)

### 6.1 目前設定

**XGBoost**:
```python
{
    'n_estimators': 100,      # 預設
    'max_depth': 6,           # 預設
    'learning_rate': 0.3,     # 預設
    'random_state': 42
}
```

**LightGBM**:
```python
{
    'n_estimators': 100,      # 預設
    'max_depth': -1,          # 預設 (無限制)
    'learning_rate': 0.1,     # 預設
    'random_state': 42
}
```

**CatBoost**:
```python
{
    'iterations': 100,        # 預設
    'depth': 6,               # 預設
    'learning_rate': 0.03,    # 預設
    'random_state': 42,
    'verbose': False
}
```

### 6.2 建議調整方向

欲讓「測試集 XGBoost/LightGBM 效果最佳」,建議:

1. **增加樹的數量**: `n_estimators = 200~500`
2. **調整學習率**: `learning_rate = 0.01~0.05` (降低,配合增加樹數量)
3. **限制樹深度**: `max_depth = 3~5` (避免過擬合)
4. **使用 Early Stopping**: 監控驗證集表現,提前停止訓練

**是否需要進行超參數調優?** (例如使用 GridSearch 或 Bayesian Optimization)

---

## 七、執行流程確認

### 7.1 已完成項目

- [x] 資料清洗 (缺失值處理、月薪範圍值修正)
- [x] 資料型態轉換
- [x] 違約定義 (M2+ 規則)
- [x] 特徵工程設計 (6 個新特徵)
- [x] 特徵清單整理 (15 個最終特徵)

### 7.2 待確認項目

請確認以下項目後,再執行模型訓練:

1. **特徵工程方法** ✓/✗
   - 6 個衍生特徵的計算公式是否正確?
   - 是否需要新增其他特徵? (例如: 年齡區間、收入分級等)

2. **WoE 編碼** ✓/✗
   - 5 個分類特徵使用 WoE 編碼是否適當?
   - 郵遞區號是否為徵審重點? (目前設為高優先級)

3. **模型超參數** ✓/✗
   - 使用預設參數 或 進行調優?
   - 是否需要調整 XGBoost/LightGBM 的參數?

4. **負債比替代方案** ✓/✗
   - 使用 `payment_progress_ratio` 代替負債比是否可接受?

5. **剩餘缺失值** ✓/✗
   - loan term (1筆), job tenure (1筆), paid installments (1筆) 如何處理?
   - 建議: 填補中位數/眾數 或 刪除該 3 筆資料?

---

## 八、下一步行動

**確認上述項目後,將執行**:

1. 載入處理後資料 (`DPM_merged_cleaned.xlsx`)
2. 定義違約標籤 (M2+)
3. 計算 6 個衍生特徵
4. 分割訓練集/測試集 (80/20)
5. WoE 編碼 (僅在訓練集上 fit)
6. 訓練 3 個模型 (XGBoost, LightGBM, CatBoost)
7. 評估模型表現 (AUC, Precision, Recall, F1)
8. 分析特徵重要性 (IV 值, SHAP)
9. 選擇最佳模型

---
